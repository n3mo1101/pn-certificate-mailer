{% extends 'base.html' %}

{% block title %}Send Certificates{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Send Certificates</h2>
    </div>
    
    <div class="card-body">
        {% if testing_mode %}
        <div class="alert alert-warning">
            <strong>⚠ TESTING MODE ENABLED</strong><br>
            Files will be sent directly to specified test email address regardless of filename.<br>
            To disable, set <code>CERTIFICATE_TESTING_MODE = False</code> in settings.py
        </div>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data" id="certificateForm">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ form.template.id_for_label }}">Select Email Template *</label>
                {{ form.template }}
                {% if form.template.help_text %}
                    <small class="form-text">{{ form.template.help_text }}</small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="id_certificates">Upload Certificate Files *</label>
                <input type="file" name="certificates" multiple accept=".pdf" class="form-control" id="id_certificates" required>
                <small class="form-text">Select one or more PDF certificates</small>
                <small class="form-text alert alert-info">
                    <strong>Filename format:</strong> 2000-1-0001.pdf or 200010001.pdf<br>
                    <strong>File size:</strong> Maximum of 10MB per file<br>
                    <small>Note: For large batches (50+ certificates), the process may take several minutes</small>
                </small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="sendBtn">Send Certificates</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('certificateForm').reset(); document.getElementById('fileCount').innerHTML = '';">Reset Form</button>
            </div>
        </form>
        
        <div id="fileCount" style="margin-top: 1rem; color: var(--dark-gray);"></div>
    </div>
</div>

<div id="progressModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Sending Certificates...</h3>
        </div>
        <div class="modal-body">
            <div class="progress-spinner"></div>
            <div id="progressText" class="progress-text">Preparing to send...</div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressStats" class="progress-stats"></div>
        </div>
    </div>
</div>

{% if recent_logs %}
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3>Recent Email Logs</h3>
        <p>Last 20 certificate deliveries</p>
    </div>
    <div class="card-body">
        <table class="log-table">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Email</th>
                    <th>Certificate File</th>
                    <th>Status</th>
                    <th>Sent At</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody>
                {% for log in recent_logs %}
                <tr>
                    <td>{{ log.student_id }}</td>
                    <td>{{ log.email }}</td>
                    <td>{{ log.certificate_filename }}</td>
                    <td>
                        {% if log.status == 'success' %}
                            <span class="badge badge-success">Success</span>
                        {% else %}
                            <span class="badge badge-error">Failed</span>
                        {% endif %}
                    </td>
                    <td>{{ log.sent_at|date:"M d, Y H:i" }}</td>
                    <td style="max-width: 300px; word-wrap: break-word;">
                        {{ log.error_message|default:"-" }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: var(--white);
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        background: linear-gradient(135deg, var(--lighter-green), var(--accent-green));
        color: var(--white);
        padding: 1.5rem 2rem;
        border-radius: 15px 15px 0 0;
    }
    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
    }
    .modal-body {
        padding: 2rem;
        text-align: center;
    }
    .progress-spinner {
        border: 4px solid var(--gray);
        border-top: 4px solid var(--light-green);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .progress-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-green);
        margin-bottom: 1rem;
    }
    .progress-bar-container {
        width: 100%;
        height: 30px;
        background-color: var(--light-gray);
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, var(--light-green), var(--accent-green));
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 15px;
    }
    .progress-stats {
        font-size: 0.95rem;
        color: var(--dark-gray);
        line-height: 1.6;
    }
</style>

<script>
    document.getElementById('id_certificates').addEventListener('change', function(e) {
        const fileCount = e.target.files.length;
        const countDiv = document.getElementById('fileCount');
        if (fileCount > 0) {
            countDiv.innerHTML = `<strong>✓ ${fileCount} file(s) selected</strong>`;
            countDiv.style.color = '#4caf50';
        } else {
            countDiv.innerHTML = '';
        }
    });
    
    document.getElementById('certificateForm').addEventListener('submit', function(e) {
        const fileCount = document.getElementById('id_certificates').files.length;
        
        if (fileCount > 0 && confirm(`Are you sure you want to send ${fileCount} certificate(s)?`)) {
            document.getElementById('progressModal').style.display = 'flex';
            document.getElementById('progressText').textContent = `Sending ${fileCount} certificates...`;
            document.getElementById('sendBtn').disabled = true;
        } else {
            e.preventDefault();
        }
    });
</script>
{% endblock %}